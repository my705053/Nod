-- --------------------------------
-- Create Sequence for Nod Tables
-- --------------------------------
DROP TABLE IF EXISTS atms_sequence;
CREATE TABLE atms_sequence(
         name VARCHAR(50) NOT NULL,
         current_value INT NOT NULL,
         increment INT NOT NULL DEFAULT 1,
         PRIMARY KEY (name)
) ENGINE=InnoDB;

DROP FUNCTION IF EXISTS currval;
DELIMITER $
CREATE FUNCTION currval (seq_name VARCHAR(50))
         RETURNS INTEGER
         LANGUAGE SQL
         DETERMINISTIC
         CONTAINS SQL
         SQL SECURITY DEFINER
         COMMENT ''
BEGIN
         DECLARE value INTEGER;
         SET value = 0;
         SELECT current_value INTO value
                   FROM atms_sequence
                   WHERE name = seq_name;
         RETURN value;
END
$
DELIMITER ;

-- 取下一个值的函数
DROP FUNCTION IF EXISTS nextval;
DELIMITER $
CREATE FUNCTION nextval (seq_name VARCHAR(50))
         RETURNS INTEGER
         LANGUAGE SQL
         DETERMINISTIC
         CONTAINS SQL
         SQL SECURITY DEFINER
         COMMENT ''
BEGIN
         UPDATE atms_sequence
                   SET current_value = current_value + increment
                   WHERE name = seq_name;
         RETURN currval(seq_name);
END
$
DELIMITER ;
 
-- 更新当前值的函数
DROP FUNCTION IF EXISTS setval;
DELIMITER $
CREATE FUNCTION setval (seq_name VARCHAR(50), value INTEGER)
         RETURNS INTEGER
         LANGUAGE SQL
         DETERMINISTIC
         CONTAINS SQL
         SQL SECURITY DEFINER
         COMMENT ''
BEGIN
         UPDATE atms_sequence
                   SET current_value = value
                   WHERE name = seq_name;
         RETURN currval(seq_name);
END
$
DELIMITER ;


INSERT INTO atms_sequence VALUES ('nod_carte_seq', 0, 1);
INSERT INTO atms_sequence VALUES ('nod_carte_dish_seq', 0, 1);
INSERT INTO atms_sequence VALUES ('nod_dish_seq', 0, 1);
INSERT INTO atms_sequence VALUES ('nod_dish_category_seq', 0, 1);
INSERT INTO atms_sequence VALUES ('nod_order_seq', 0, 1);
INSERT INTO atms_sequence VALUES ('nod_order_detail_seq', 0, 1);
INSERT INTO atms_sequence VALUES ('nod_restaurant_info_seq', 0, 1);
INSERT INTO atms_sequence VALUES ('nod_role_seq', 0, 1);
INSERT INTO atms_sequence VALUES ('nod_table_seq', 0, 1);
INSERT INTO atms_sequence VALUES ('nod_user_seq', 0, 1);

-- --------------------------------
-- Create Sequence for Nod Tables
-- --------------------------------
